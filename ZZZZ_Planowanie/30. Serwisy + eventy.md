poniżej masz wersję **backend: serwisy + eventy** dla zakresu **od rynku do “setup planned/blocked”**, zgodnie z Blueprint (łącznie z politykami **11C** i **24** jako osobny “Policy Engine”).

---

## Event bus

* `EventBus` (Kafka/Rabbit/SNS+SQS lub prosty internal dispatcher)
* Każdy event ma: `event_id`, `occurred_at`, `actor` (system/user), `correlation_id`, `payload`

---

# 1) Planning & Modes

## 1.1 `WeeklyModeService`

**Odpowiada za:** weekly mode (trend/range/vol) + limity tygodnia.
**Eventy:**

* `WeeklyModeSet`
* `WeeklyRiskCapsUpdated`

## 1.2 `DailyPlanService`

**Odpowiada za:** pre-market scenariusze (bull/bear/no-trade) + dzienne limity “top setups only”.
**Eventy:**

* `DailyPlanCreated`
* `DailyPlanLocked` (blokada “bez planu nie handlujesz”)
* `DailyTopSetupsLimitSet`

## 1.3 `WatchlistService`

**Odpowiada za:** core watchlist + shortlist na dzień.
**Eventy:**

* `CoreWatchlistUpdated`
* `DailyShortlistGenerated`
* `TickerRemovedFromCoreList`

## 1.4 `LevelsService`

**Odpowiada za:** rejestr poziomów i alertów dla shortlisty (key level, invalidation candidate, targets).
**Eventy:**

* `LevelsPrepared`
* `AlertsConfigured`

---

# 2) Market Context (SPY Gate)

## 2.1 `MarketDataIngestionService`

**Odpowiada za:** pobór danych SPY/VIX/breadth (AUTO) + zapis surowych wejść.
**Eventy:**

* `MarketDataIngested`

## 2.2 `MarketSnapshotService`

**Odpowiada za:** złożenie “snapshotu rynku” (SPY bias/regime/structure/location/room + VIX + breadth).
**Eventy:**

* `MarketSnapshotCreated`
* `MarketSnapshotUpdated` (np. intraday refresh)

## 2.3 `CatalystAwarenessService`

**Odpowiada za:** flagi wydarzeń (makro/ryzyko środowiska) – manual lub feed.
**Eventy:**

* `MarketCatalystFlagged`
* `MarketCatalystCleared`

## 2.4 `MarketPermissionService`

**Odpowiada za:** decyzję Full/Reduced/Observation/Blocked + risk caps (daily) na bazie snapshotu + weekly/daily mode + konflikty.
**Eventy:**

* `MarketPermissionCalculated`
* `MarketPermissionChanged`
* `MarketBlocked` (gdy Blocked)
* `RiskCapsApplied`

---

# 3) Universe & Liquidity Gates

## 3.1 `UniverseService`

**Odpowiada za:** budowę universe z core listy + filtr bazowy.
**Eventy:**

* `UniverseBuilt`

## 3.2 `LiquidityGateService`

**Odpowiada za:** “pass/fail” po płynności (stock + opcjonalnie options liquidity jako precheck).
**Eventy:**

* `TickerLiquidityPassed`
* `TickerLiquidityFailed` (z `fail_reason_code`)
* `UniversePrunedByLiquidity`

---

# 4) Opportunity & Setup Construction (Ticker → Setup Candidate)

## 4.1 `AlignmentService`

**Odpowiada za:** alignment z rynkiem i sektorami, RS/RW, HTF confirmation.
**Eventy:**

* `TickerAlignmentCalculated`
* `TickerAlignmentFailed` (jeśli twardy fail)

## 4.2 `SetupClassificationService`

**Odpowiada za:** typ setupu (pullback/breakout/range/reversal attempt) + quality tags.
**Eventy:**

* `SetupTypeIdentified`
* `SetupStructureQualified` (clean/messy/chop)

## 4.3 `LocationRoomService`

**Odpowiada za:** location przy levelu + room to move + overextension + “reward realism”.
**Eventy:**

* `SetupLocationCalculated`
* `SetupRoomCalculated`
* `SetupOverextensionFlagged`
* `SetupRewardRealismFlagged`

---

# 5) Thesis & Risk Definition (Must-have fields)

## 5.1 `ThesisService`

**Odpowiada za:** teza + must-happen condition + clarity flag.
**Eventy:**

* `SetupThesisDefined`
* `SetupMustHappenDefined`
* `SetupClarityFlagged` (np. “not obvious”)

## 5.2 `InvalidationService`

**Odpowiada za:** invalidation level (stop logic) + walidacja kompletności.
**Eventy:**

* `SetupInvalidationDefined`
* `SetupInvalidationMissing` (hard blocker)

## 5.3 `RiskRewardService`

**Odpowiada za:** RR calculation + min RR threshold.
**Eventy:**

* `SetupRiskRewardCalculated`
* `SetupRiskRewardFailed` (np. RR<2)

---

# 6) Quality, Policies & Decision (A/B/C/D + “allowed to plan”)

## 6.1 `GradingService`

**Odpowiada za:** grade A/B/C/D na bazie market permission + struktury + ryzyka + RR + clarity.
**Eventy:**

* `SetupGraded`
* `SetupGradeDowngraded` (np. przez flagi)

## 6.2 `SizingService`

**Odpowiada za:** mapowanie grade → sizing profile (normal/reduced/micro/blocked) + risk%.
**Eventy:**

* `SizingProfileAssigned`
* `RiskPerTradeAssigned`

## 6.3 `PolicyEngineService`  ✅ (tu trafiają 11C i 24)

**Odpowiada za:** globalne zasady Blueprint (nie kroki), które mogą *blokować* lub *ograniczać* setup mimo poprawnych pól.

* **11C Edge Concentration Discipline**: dopuszczaj tylko typy/konfiguracje z dodatnią expectancy (albo “whitelist edge”).
* **24 Simplicity & Selectivity Principle**: tylko “obvious setups”, limit top X, odrzucaj “interpretacyjne”.

**Eventy:**

* `EdgePolicyEvaluated`
* `EdgeNotProvenFlagged` (→ Observation/Blocked)
* `SimplicityPolicyEvaluated`
* `SetupNotObviousFlagged`
* `DailyTopSetupsCapReached`

## 6.4 `ProcessEnforcementService`

**Odpowiada za:** “nie przejdziesz dalej bez…” (kompletność + kolejność).
**Eventy:**

* `SetupValidationPassed`
* `SetupValidationFailed` (missing invalidation/RR/thesis/etc.)
* `StageTransitionDenied`

## 6.5 `SetupDecisionService`

**Odpowiada za:** finalny status *na etapie planowania* (do setupu).
**Eventy:**

* `SetupPlanned` (status: Planned / NeedsTrigger)
* `SetupBlocked` (z listą reason codes)
* `SetupObservationOnly`

---

# 7) Read Models / Query API (do UI)

Żeby UI było szybkie, warto mieć projekcje (CQRS):

## 7.1 `DashboardReadModelService`

**Odpowiada za:** agregaty: market permission, shortlist, top setups, reasons.
**Eventy:**

* (subskrybuje wszystko powyżej, sam nie musi emitować)

---
